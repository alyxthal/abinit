os:
  - linux
  #- osx

language: c

sudo: required
dist: trusty

install:

  # Install requirements. Taken from yoda's post http://forum.abinit.org/viewtopic.php?f=2&t=1391
  #- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
  #     brew update;
  #     brew install gcc;
  #  fi
  #- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
  #     sudo apt-get install liblapack-dev libblas-dev;
  #  fi
  - sudo apt-get update
  - sudo apt-get -y install gcc gfortran g++
  - sudo apt-get -y install patch
  # blas/lapack
  - sudo apt-get -y install libatlas-base-dev libatlas3gf-base
  - sudo apt-get -y install liblapack3gf liblapack-dev
  - sudo apt-get -y install libblas3gf libblas-dev
  # fftw3 (Abinit requires single precision version as well)
  - sudo apt-get -y install libfftw3-dev
  #- sudo apt-get -y install fftw3 libfftw3-dev libfftw3-single3 
  # netcdf
  #- sudo apt-get -y install libnetcdf-dev

  #- sudo apt-get install libhdf5-serial-dev libnetcdf-dev libnetcdf4

  # netcdf4 on trusty
  - sudo apt-get install libnetcdff5 libnetcdf-dev libhdf5-serial-dev

  # openmpi
  - sudo apt-get -y install openmpi-bin openmpi-common libopenmpi-dev

  - ./config/scripts/makemake 

  - ./configure --help
  - ./configure --prefix="/usr/local" FCFLAGS="-g -O2 -ffree-line-length-none" 
        --enable-mpi="yes" --enable-mpi-io="yes" --with-mpi-prefix="/usr" 
        --with-trio-flavor="netcdf" 
        --with-netcdf-incs="-I/usr/include" --with-netcdf-libs="-L/usr/lib -lnetcdf -lnetcdff"
        --with-linalg-flavor="atlas" --with-linalg-libs="-L/usr/lib -llapack -lf77blas -lcblas -latlas"
        --with-fft-flavor="fftw3" --with-fft-incs="-I/usr/include/" --with-fft-libs="-L/usr/lib -lfftw3 -lfftw3f"
        --with-dft-flavor="atompaw-fallback+libxc-fallback+wannier90-fallback" 
        --enable-gw-dpc="yes"

  - make -j4
  - make check
  - sudo make install

# command to run tests
script: make check && tests/runtests.py v1 v2 -o1 -j2 && tests/runtests.py paral -o1 -n2

branches:
  only:
    - travis
    - master
    - develop

notifications:
  email:
    recipients:
      - gmatteo@gmail.com
    on_success: change
    on_failure: always
